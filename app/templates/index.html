{% extends "base.html" %}

{% block title %}To-Do List{% endblock %}

{% block content %}
{% import "_macros.html" as macros %}

<div class="container-fluid">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse d-flex justify-content-between" id="navbarNav">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-tasks icon-pad"></i>To-Do List
                </a>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.logout') }}">
                            <i class="fas fa-sign-out-alt icon-pad"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="row g-4">
        <!-- Sidebar -->
        <div class="col-lg-3 col-md-4">
            <!-- Filters & Sort -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-filter icon-pad"></i>Filters & Sort
                    </h6>
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('main.index') }}">
                        <div class="mb-3">
                            <label for="sort_by" class="form-label">Sort by:</label>
                            <select name="sort_by" id="sort_by" class="form-select">
                                <option value="priority" {% if sort_by =='priority' %}selected{% endif %}>Priority</option>
                                <option value="title" {% if sort_by =='title' %}selected{% endif %}>Title</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="filter_by" class="form-label">Filter by priority:</label>
                            <select name="filter_by" id="filter_by" class="form-select">
                                <option value="" {% if not filter_by %}selected{% endif %}>All</option>
                                <option value="1" {% if filter_by =='1' %}selected{% endif %}>Low</option>
                                <option value="2" {% if filter_by =='2' %}selected{% endif %}>Medium</option>
                                <option value="3" {% if filter_by =='3' %}selected{% endif %}>High</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="show_completed" class="form-label">Show completed:</label>
                            <select name="show_completed" id="show_completed" class="form-select">
                                <option value="all" {% if show_completed =='all' %}selected{% endif %}>All Tasks</option>
                                <option value="false" {% if show_completed =='false' %}selected{% endif %}>Incomplete Only</option>
                                <option value="true" {% if show_completed =='true' %}selected{% endif %}>Completed Only</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search icon-pad"></i>Apply
                        </button>
                    </form>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-bolt icon-pad"></i>Quick Actions
                    </h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="expandAllSubtasks()">
                            <i class="fas fa-expand-arrows-alt icon-pad"></i>Expand All
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="collapseAllSubtasks()">
                            <i class="fas fa-compress-arrows-alt icon-pad"></i>Collapse All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h6 class="card-title mb-3">
                        <i class="fas fa-search icon-pad"></i>Search Tasks
                    </h6>
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm" id="taskSearch" placeholder="Search tasks...">
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dark Mode Toggle -->
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <span><i class="fas fa-moon icon-pad"></i>Dark Mode</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="darkModeToggle">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <!-- Add New Task -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-plus icon-pad"></i>Add New Task
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <small>
                            <i class="fas fa-info-circle icon-pad"></i>
                            This creates a new main task. Use the <i class="fas fa-plus"></i> button next to existing tasks to add subtasks.
                        </small>
                    </div>
                    <form action="{{ url_for('main.add') }}" method="POST" class="row g-3">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="col-md-6">
                            <input type="text" name="title" class="form-control" placeholder="Enter task title..." required>
                        </div>
                        <div class="col-md-3">
                            <select name="priority" class="form-select">
                                <option value="1" class="text-success">Low Priority</option>
                                <option value="2" class="text-warning" selected>Medium Priority</option>
                                <option value="3" class="text-danger">High Priority</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus icon-pad"></i>Add Task
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Markdown Import -->
            <div class="card shadow-sm mb-4">
                <div class="card-header" id="markdownHeader">
                    <h6 class="mb-0">
                        <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse"
                                data-bs-target="#markdownUploadCollapse" aria-expanded="false" aria-controls="markdownUploadCollapse">
                            <i class="fas fa-file-upload icon-pad"></i>Import Tasks from Markdown File
                            <i class="fas fa-chevron-down ms-2"></i>
                        </button>
                    </h6>
                </div>
                <div id="markdownUploadCollapse" class="collapse">
                    <div class="card-body">
                        <form id="markdownUploadForm" action="{{ url_for('main.import_markdown') }}" method="POST" enctype="multipart/form-data">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="markdownFile" class="form-label">Choose Markdown File</label>
                                    <input type="file" class="form-control" id="markdownFile" name="markdown_file" accept=".md,.txt" required>
                                    <div class="form-text">Upload a markdown file with tasks. Supports .md and .txt files.</div>
                                </div>
                                <div class="col-md-3">
                                    <label for="defaultPriority" class="form-label">Default Priority</label>
                                    <select name="default_priority" id="defaultPriority" class="form-select">
                                        <option value="1">Low Priority</option>
                                        <option value="2" selected>Medium Priority</option>
                                        <option value="3">High Priority</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-info w-100">
                                        <i class="fas fa-upload icon-pad"></i>Import Tasks
                                    </button>
                                </div>
                            </div>
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="previewMode" name="preview_mode" checked>
                                <label class="form-check-label" for="previewMode">Preview before importing (recommended)</label>
                            </div>
                        </form>

                        <!-- Preview Area -->
                        <div id="previewArea" class="mt-4" style="display: none;">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">Preview of Tasks to be Imported:</h6>
                                <div id="previewContent" class="border rounded p-3 bg-light mt-2" style="max-height: 300px; overflow-y: auto;"></div>
                                <div class="mt-3">
                                    <button id="confirmImport" class="btn btn-success me-2">
                                        <i class="fas fa-check icon-pad"></i>Confirm Import
                                    </button>
                                    <button id="cancelImport" class="btn btn-secondary">
                                        <i class="fas fa-times icon-pad"></i>Cancel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Format Guide -->
                        <div class="mt-3">
                            <div class="alert alert-light">
                                <h6 class="alert-heading">Supported Formats:</h6>
                                <ul class="mb-0 small">
                                    <li><code># Main Task Title</code> - Creates a main task</li>
                                    <li><code>## Subtask Title</code> - Creates a subtask under the previous main task</li>
                                    <li><code>### Sub-subtask Title</code> - Creates a nested subtask</li>
                                    <li><code>- [ ] Task Title</code> - Creates an incomplete task</li>
                                    <li><code>- [x] Task Title</code> - Creates a completed task</li>
                                    <li><code>* Task Title</code> - Creates a task (bullet point)</li>
                                    <li><code>  - Nested item</code> - Creates nested subtask (indented)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task Statistics -->
            {% if tasks %}
                {% set task_list = tasks|list %}
                {% set total_tasks = task_list|length %}
                {% set completed_tasks = task_list|selectattr('completed')|list|length %}
                {% set high_priority_tasks = task_list|selectattr('priority', 'equalto', 3)|list|length %}

                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="h3 text-primary">{{ total_tasks }}</div>
                                <div class="text-muted">Total Tasks</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h3 text-success">{{ completed_tasks }}</div>
                                <div class="text-muted">Completed</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h3 text-warning">{{ total_tasks - completed_tasks }}</div>
                                <div class="text-muted">Remaining</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h3 text-danger">{{ high_priority_tasks }}</div>
                                <div class="text-muted">High Priority</div>
                            </div>
                        </div>
                        {% if total_tasks > 0 %}
                            <div class="progress mt-3" style="height: 10px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ (completed_tasks / total_tasks * 100)|round }}%"></div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">{{ (completed_tasks / total_tasks * 100)|round }}% Complete</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Task List -->
           <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-list icon-pad"></i>Your Tasks
                            {% if tasks %}
                                <span class="badge badge-light text-dark ml-2">{{ tasks|list|length }}</span>
                            {% endif %}
                        </h6>

                        {% if tasks %}
                        <div class="export-dropdown-container">
                            <button class="btn btn-outline-light btn-sm export-toggle">
                                <i class="fas fa-download"></i> Export <i class="fas fa-chevron-down ml-1"></i>
                            </button>
                            <div class="export-dropdown-menu">
                                <a href="{{ url_for('main.export_tasks') }}" class="export-dropdown-item">
                                    <i class="fas fa-file-text mr-2"></i>Download as Markdown
                                </a>
                                <a href="{{ url_for('main.export_tasks_pdf') }}" class="export-dropdown-item">
                                    <i class="fas fa-file-pdf mr-2"></i>Download as PDF
                                </a>
                                <div class="export-dropdown-divider"></div>
                                <span class="export-dropdown-info">
                                    <i class="fas fa-info-circle mr-1"></i>Exports all tasks with subtasks
                                </span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if tasks %}
                        <div class="task-list">
                            {% for task in tasks %}
                                {{ macros.render_task(task, 0) }}
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No tasks yet</h5>
                            <p class="text-muted">Add your first task above to get started!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Suggested Tasks -->
            {% if suggested_tasks %}
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-lightbulb icon-pad"></i>Suggested Tasks
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        {% set existing_titles = tasks|map(attribute='title')|list %}
                        {% for suggested_task in suggested_tasks %}
                            {% if suggested_task not in existing_titles %}
                                <div class="suggested-task-item p-3 border-bottom d-flex justify-content-between align-items-center">
                                    <span class="flex-grow-1">{{ suggested_task }}</span>
                                    <form action="{{ url_for('main.add_suggested', task_title=suggested_task) }}" method="POST" class="d-flex align-items-center">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <select name="priority" class="form-select form-select-sm me-2" style="width: auto;">
                                            <option value="1">Low</option>
                                            <option value="2" selected>Medium</option>
                                            <option value="3">High</option>
                                        </select>
                                        <button type="submit" class="btn btn-success btn-sm" title="Add Task">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>


.export-dropdown-container {
    position: relative;
    display: inline-block;
}

.export-dropdown-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    background: white;
    min-width: 240px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 6px;
    border: 1px solid #dee2e6;
    z-index: 1000;
    margin-top: 2px;
    padding: 4px 0;
}

.export-dropdown-container:hover .export-dropdown-menu,
.export-dropdown-menu:hover {
    display: block;
}

.export-dropdown-menu::before {
    content: '';
    position: absolute;
    top: -6px;
    right: 0;
    width: 100%;
    height: 6px;
    background: transparent;
}

.export-dropdown-item {
    display: block;
    padding: 10px 16px;
    color: #333;
    text-decoration: none;
    transition: background-color 0.2s;
    font-size: 14px;
}

.export-dropdown-item:hover {
    background-color: #f8f9fa;
    color: #0d6efd;
    text-decoration: none;
}

.export-dropdown-divider {
    height: 1px;
    background-color: #dee2e6;
    margin: 4px 0;
}

.export-dropdown-info {
    display: block;
    padding: 8px 16px;
    font-size: 12px;
    color: #6c757d;
    font-style: italic;
}

.export-toggle {
    transition: all 0.2s;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.export-dropdown-container:hover .export-toggle {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.5);
}

.export-toggle .fa-chevron-down {
    transition: transform 0.2s;
    font-size: 0.8em;
}

.export-dropdown-container:hover .export-toggle .fa-chevron-down {
    transform: rotate(180deg);
}

/* Icon padding utility */
.icon-pad {
    margin-right: 0.5rem;
}

/* Priority badges */
.priority-badge {
    font-size: 0.75em;
}

.priority-1 {
    background-color: #28a745 !important;
    color: white;
}

.priority-2 {
    background-color: #ffc107 !important;
    color: #212529;
}

.priority-3 {
    background-color: #dc3545 !important;
    color: white;
}

/* Task styling */
.task-completed {
    opacity: 0.7;
    background-color: #f8f9fa;
}

.task-container:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s ease;
}

/* Button styling */
.subtask-toggle,
.add-subtask-btn {
    border: none !important;
    padding: 0.25rem 0.5rem;
    transition: all 0.2s ease;
}

.subtask-toggle:hover,
.add-subtask-btn:hover {
    transform: scale(1.1);
}

/* Subtask container styling */
.subtasks-container {
    border-left: 3px solid #dee2e6;
    margin-left: 1rem;
    transition: all 0.3s ease;
}

.task-depth-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    margin-right: 0.5rem;
}

/* Suggested tasks */
.suggested-task-item:last-child {
    border-bottom: none !important;
}

/* Form styling */
.add-subtask-form {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 200px;
    }
}

/* Task nesting indicators */
.task-container[data-depth="0"] { border-left: 4px solid #007bff; }
.task-container[data-depth="1"] { border-left: 3px solid #28a745; margin-left: 10px; }
.task-container[data-depth="2"] { border-left: 2px solid #ffc107; margin-left: 20px; }
.task-container[data-depth="3"] { border-left: 2px solid #dc3545; margin-left: 30px; }
.task-container[data-depth="4"] { border-left: 2px solid #6f42c1; margin-left: 40px; }
.task-container[data-depth="5"] { border-left: 2px solid #e83e8c; margin-left: 50px; }

/* Dark mode styles */
.dark-mode {
    background-color: #1a1a1a;
    color: #e0e0e0;
}

.dark-mode .badge.bg-light.text-dark {
    background-color: #555 !important; /* dark gray background */
    color: #fff !important;            /* white text */
}

.dark-mode .card {
    background-color: #2d2d2d;
    border-color: #404040;
    color: #e0e0e0;
}

.dark-mode .card-header {
    background-color: #3a3a3a !important;
    border-bottom-color: #404040;
    color: #e0e0e0 !important;
}

.dark-mode .bg-light {
    background-color: #3a3a3a !important;
}

.dark-mode .border-bottom {
    border-bottom-color: #404040 !important;
}

.dark-mode .task-completed {
    background-color: #333 !important;
}

.dark-mode .form-control,
.dark-mode .form-select {
    background-color: #404040;
    border-color: #555;
    color: #e0e0e0;
}

.dark-mode .form-control:focus,
.dark-mode .form-select:focus {
    background-color: #404040;
    border-color: #0d6efd;
    color: #e0e0e0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.dark-mode .alert-light {
    background-color: #404040;
    border-color: #555;
    color: #e0e0e0;
}

.dark-mode .add-subtask-form {
    background-color: #404040;
    border-color: #555;
}

/* Search highlighting */
.task-highlight {
    background-color: yellow !important;
    font-weight: bold;
}

.dark-mode .task-highlight {
    background-color: #ffd700 !important;
    color: #000 !important;
}

/* Loading states */
.loading {
    position: relative;
}

.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>

{% endblock %}

{% block custom_js %}
<script>
/**
 * Task Management System - JavaScript Functions
 * Handles form validation, subtask management, markdown import, search, and UI interactions
 */

// =============================================================================
// FORM VALIDATION
// =============================================================================

function validateMainTaskForm() {
    const title = document.getElementById('main-task-title').value.trim();
    if (!title) {
        alert('Please enter a task title');
        return false;
    }
    return true;
}

function validateSubtaskForm(taskId) {
    const form = document.getElementById(`add-subtask-form-${taskId}`);
    if (!form) return false;

    const titleInput = form.querySelector('input[name="title"]');
    const parentIdInput = form.querySelector('input[name="parent_task_id"]');

    if (!titleInput || !titleInput.value.trim()) {
        alert('Please enter a subtask title');
        if (titleInput) titleInput.focus();
        return false;
    }

    if (!parentIdInput || !parentIdInput.value) {
        alert('Error: Parent task ID is missing');
        return false;
    }

    return true;
}

// =============================================================================
// SUBTASK MANAGEMENT
// =============================================================================

function showAddSubtaskForm(taskId) {
    // Hide all other open subtask forms first
    const allForms = document.querySelectorAll('.add-subtask-form');
    allForms.forEach(form => {
        if (form.id !== `add-subtask-form-${taskId}`) {
            form.style.display = 'none';
        }
    });

    // Show the specific form for this task
    const form = document.getElementById(`add-subtask-form-${taskId}`);
    if (form) {
        form.style.display = 'block';

        // Focus on the title input
        const titleInput = form.querySelector('input[name="title"]');
        if (titleInput) titleInput.focus();

        // Ensure the parent task ID is set correctly
        const parentIdInput = form.querySelector('input[name="parent_task_id"]');
        if (parentIdInput) parentIdInput.value = taskId;
    }
}

function hideAddSubtaskForm(taskId) {
    const form = document.getElementById(`add-subtask-form-${taskId}`);
    if (form) {
        form.style.display = 'none';

        // Clear the form
        const titleInput = form.querySelector('input[name="title"]');
        if (titleInput) titleInput.value = '';

        // Reset priority to default
        const prioritySelect = form.querySelector('select[name="priority"]');
        if (prioritySelect) prioritySelect.value = '2'; // Default to Medium
    }
}

function toggleSubtasks(taskId) {
    const subtasksContainer = document.getElementById(`subtasks-${taskId}`);
    const toggleButton = document.getElementById(`toggle-${taskId}`);
    const toggleIcon = toggleButton ? toggleButton.querySelector('i') : null;

    if (subtasksContainer) {
        const isVisible = subtasksContainer.style.display !== 'none';

        if (isVisible) {
            subtasksContainer.style.display = 'none';
            if (toggleIcon) toggleIcon.className = 'fas fa-chevron-right';
        } else {
            subtasksContainer.style.display = 'block';
            if (toggleIcon) toggleIcon.className = 'fas fa-chevron-down';
        }
    }
}

function expandAllSubtasks() {
    const subtasksContainers = document.querySelectorAll('.subtasks-container');
    const toggleIcons = document.querySelectorAll('.subtask-toggle i');

    subtasksContainers.forEach(container => {
        container.style.display = 'block';
    });

    toggleIcons.forEach(icon => {
        icon.className = 'fas fa-chevron-down';
    });
}

function collapseAllSubtasks() {
    const subtasksContainers = document.querySelectorAll('.subtasks-container');
    const toggleIcons = document.querySelectorAll('.subtask-toggle i');

    subtasksContainers.forEach(container => {
        container.style.display = 'none';
    });

    toggleIcons.forEach(icon => {
        icon.className = 'fas fa-chevron-right';
    });
}

// =============================================================================
// MARKDOWN IMPORT FUNCTIONALITY
// =============================================================================

function parseMarkdownTasks(content) {
    const lines = content.split('\n');
    const stack = []; // Stack of heading tasks by level
    const tasks = [];

    lines.forEach((rawLine, index) => {
        const line = rawLine.replace(/\t/g, '  ').trimEnd();
        if (!line.trim()) return;

        const lineNumber = index + 1;

        // Heading (e.g., #, ##, ###)
        const headingMatch = line.match(/^(#{1,6})\s+(.*)/);
        if (headingMatch) {
            const level = headingMatch[1].length;
            const title = headingMatch[2].trim();
            const task = {
                title,
                completed: false,
                subtasks: [],
                lineNumber
            };

            // Trim stack to one level above
            stack.length = level - 1;

            if (stack.length === 0) {
                tasks.push(task);
            } else {
                stack[stack.length - 1].subtasks.push(task);
            }

            stack[level - 1] = task;
            return;
        }

        // Checkbox Task (- [ ] or - [x])
        const checkboxMatch = line.match(/^(\s*)- \[( |x|X)\] (.*)/);
        if (checkboxMatch) {
            const completed = checkboxMatch[2].toLowerCase() === 'x';
            const title = checkboxMatch[3].trim();
            const task = {
                title,
                completed,
                subtasks: [],
                lineNumber
            };

            // Find the most recent heading task from the stack
            for (let i = stack.length - 1; i >= 0; i--) {
                if (stack[i]) {
                    stack[i].subtasks.push(task);
                    return;
                }
            }

            // If no heading above, treat it as top-level
            tasks.push(task);
        }
    });

    return tasks;
}


function displayPreview(tasks) {
    let html = '';

    if (tasks.length === 0) {
        html = '<p class="text-muted">No tasks found in the markdown file.</p>';
    } else {
        tasks.forEach(task => {
            html += `<div class="preview-task">
                <strong>${task.completed ? '✓' : '○'} ${task.title}</strong>
            </div>`;

            task.subtasks.forEach(subtask => {
                html += `<div class="preview-subtask">
                    ${subtask.completed ? '✓' : '○'} ${subtask.title}
                </div>`;
            });
        });

        const totalSubtasks = tasks.reduce((sum, task) => sum + task.subtasks.length, 0);
        html += `<div class="mt-2"><small class="text-muted">
            Found ${tasks.length} main task(s) with ${totalSubtasks} subtask(s)
        </small></div>`;
    }

    const previewContent = document.getElementById('previewContent');
    if (previewContent) {
        previewContent.innerHTML = html;
    }
}

// =============================================================================
// SEARCH FUNCTIONALITY
// =============================================================================

function searchTasks(query) {
    const taskContainers = document.querySelectorAll('.task-container');
    const searchTerm = query.toLowerCase().trim();

    taskContainers.forEach(container => {
        const taskTitle = container.querySelector('.task-title, .card-body h6, .d-flex span');
        const taskDescription = container.querySelector('.task-description, .text-muted');

        if (taskTitle) {
            const titleText = taskTitle.textContent.toLowerCase();
            const descriptionText = taskDescription ? taskDescription.textContent.toLowerCase() : '';
            let shouldShow = false;

            // Remove previous highlights
            removeHighlights(taskTitle);
            if (taskDescription) removeHighlights(taskDescription);

            if (searchTerm === '') {
                shouldShow = true;
            } else if (titleText.includes(searchTerm) || descriptionText.includes(searchTerm)) {
                shouldShow = true;

                // Add highlighting
                if (titleText.includes(searchTerm)) {
                    highlightText(taskTitle, searchTerm);
                }
                if (descriptionText.includes(searchTerm) && taskDescription) {
                    highlightText(taskDescription, searchTerm);
                }
            }

            // Show/hide the entire task container
            if (shouldShow) {
                container.style.display = 'block';
                // Also show parent containers if this is a subtask
                let parentContainer = container.closest('.subtasks-container');
                while (parentContainer) {
                    parentContainer.style.display = 'block';
                    const parentTask = parentContainer.previousElementSibling;
                    if (parentTask && parentTask.classList.contains('task-container')) {
                        parentTask.style.display = 'block';
                    }
                    parentContainer = parentContainer.parentElement.closest('.subtasks-container');
                }
            } else {
                container.style.display = 'none';
            }
        }
    });

    updateSearchResultsCount(query);
}

function highlightText(element, searchTerm) {
    if (!element || !searchTerm) return;

    const originalText = element.textContent;
    const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
    const highlightedText = originalText.replace(regex, '<span class="task-highlight">$1</span>');

    if (highlightedText !== originalText) {
        element.innerHTML = highlightedText;
    }
}

function removeHighlights(element) {
    if (!element) return;

    const highlights = element.querySelectorAll('.task-highlight');
    highlights.forEach(highlight => {
        const parent = highlight.parentNode;
        parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
        parent.normalize();
    });
}

function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function updateSearchResultsCount(query) {
    const visibleTasks = document.querySelectorAll('.task-container[style*="block"], .task-container:not([style*="none"])');
    const totalTasks = document.querySelectorAll('.task-container');
    // Results counter can be implemented here if needed
}

function clearSearch() {
    const searchInput = document.getElementById('taskSearch');
    if (searchInput) {
        searchInput.value = '';
        searchTasks('');
        searchInput.focus();
    }
}

// =============================================================================
// FILTERING FUNCTIONALITY
// =============================================================================

function applyClientSideFilters(showCompleted, filterBy) {
    const taskContainers = document.querySelectorAll('.task-container');

    taskContainers.forEach(container => {
        let shouldShow = true;

        // Check completion status
        const isCompleted = container.classList.contains('task-completed') ||
                           container.querySelector('.task-completed') !== null ||
                           container.querySelector('input[type="checkbox"]:checked') !== null;

        if (showCompleted === 'true' && !isCompleted) {
            shouldShow = false;
        } else if (showCompleted === 'false' && isCompleted) {
            shouldShow = false;
        }

        // Check priority filter
        if (filterBy && shouldShow) {
            const priorityBadge = container.querySelector('.priority-badge, .badge');
            let taskPriority = null;

            if (priorityBadge) {
                if (priorityBadge.classList.contains('priority-1') || priorityBadge.textContent.toLowerCase().includes('low')) {
                    taskPriority = '1';
                } else if (priorityBadge.classList.contains('priority-2') || priorityBadge.textContent.toLowerCase().includes('medium')) {
                    taskPriority = '2';
                } else if (priorityBadge.classList.contains('priority-3') || priorityBadge.textContent.toLowerCase().includes('high')) {
                    taskPriority = '3';
                }
            }

            if (taskPriority !== filterBy) {
                shouldShow = false;
            }
        }

        // Apply visibility
        container.style.display = shouldShow ? 'block' : 'none';
    });

    updateTaskCount();
}

function updateTaskCount() {
    const visibleTasks = document.querySelectorAll('.task-container:not([style*="none"])');
    const taskCountBadge = document.querySelector('.card-header .badge');

    if (taskCountBadge) {
        taskCountBadge.textContent = visibleTasks.length;
    }
}

// =============================================================================
// DRAG AND DROP FUNCTIONALITY
// =============================================================================

function initializeDragAndDrop() {
    const taskContainers = document.querySelectorAll('.task-container');

    taskContainers.forEach(container => {
        container.draggable = true;

        container.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('text/plain', container.dataset.taskId || '');
            container.classList.add('dragging');
        });

        container.addEventListener('dragend', function(e) {
            container.classList.remove('dragging');
        });

        container.addEventListener('dragover', function(e) {
            e.preventDefault();
            container.classList.add('drag-over');
        });

        container.addEventListener('dragleave', function(e) {
            container.classList.remove('drag-over');
        });

        container.addEventListener('drop', function(e) {
            e.preventDefault();
            container.classList.remove('drag-over');
            const draggedTaskId = e.dataTransfer.getData('text/plain');
            // Reordering logic would be implemented here
        });
    });
}

// =============================================================================
// INITIALIZATION FUNCTIONS
// =============================================================================

function initializeSubtaskFunctionality() {
    // Add subtask button event listeners
    const addSubtaskButtons = document.querySelectorAll('.add-subtask-btn');
    addSubtaskButtons.forEach(button => {
        // Remove existing onclick handlers and add new ones
        button.removeAttribute('onclick');
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);

        newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const taskId = findTaskId(this);
            if (taskId) {
                showAddSubtaskForm(taskId);
            }
        });
    });

    // Subtask toggle button event listeners
    const toggleButtons = document.querySelectorAll('.subtask-toggle');
    toggleButtons.forEach(button => {
        button.removeAttribute('onclick');
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);

        newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const taskId = this.id.replace('toggle-', '');
            if (taskId) {
                toggleSubtasks(taskId);
            }
        });
    });

    // Subtask form validation
    const subtaskForms = document.querySelectorAll('.add-subtask-form form');
    subtaskForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const formContainer = this.closest('.add-subtask-form');
            const taskId = formContainer ? formContainer.id.replace('add-subtask-form-', '') : null;

            if (taskId && !validateSubtaskForm(taskId)) {
                e.preventDefault();
                return false;
            }
        });
    });

    // Escape key handler to close forms
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const visibleForms = document.querySelectorAll('.add-subtask-form[style*="block"]');
            visibleForms.forEach(form => {
                const taskId = form.id.replace('add-subtask-form-', '');
                hideAddSubtaskForm(taskId);
            });
        }
    });
}

function findTaskId(element) {
    // Try multiple methods to find the task ID
    let taskId = null;

    // Method 1: Check for onclick attribute
    const onclickAttr = element.getAttribute('onclick');
    if (onclickAttr) {
        const match = onclickAttr.match(/showAddSubtaskForm\((\d+)\)/);
        if (match) {
            taskId = match[1];
        }
    }

    // Method 2: Look for nearby toggle button
    if (!taskId) {
        const taskContainer = element.closest('.task-container');
        if (taskContainer) {
            const toggleButton = taskContainer.querySelector('.subtask-toggle');
            if (toggleButton && toggleButton.id) {
                taskId = toggleButton.id.replace('toggle-', '');
            }
        }
    }

    // Method 3: Look for nearby form
    if (!taskId) {
        const taskContainer = element.closest('.task-container');
        if (taskContainer) {
            const subtaskForm = taskContainer.querySelector('.add-subtask-form');
            if (subtaskForm && subtaskForm.id) {
                taskId = subtaskForm.id.replace('add-subtask-form-', '');
            }
        }
    }

    return taskId;
}

function initializeSearchFunctionality() {
    const searchInput = document.getElementById('taskSearch');
    const clearSearchBtn = searchInput?.parentElement.querySelector('button');

    if (searchInput) {
        // Search input events
        searchInput.addEventListener('input', function(e) {
            searchTasks(e.target.value);
        });

        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                searchTasks(e.target.value);
            }
        });

        // Clear search functionality
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', function() {
                searchInput.value = '';
                searchTasks('');
                searchInput.focus();
            });
        }
    }
}

function initializeClientSideFiltering() {
    // Get current filter state from URL params
    const urlParams = new URLSearchParams(window.location.search);
    const showCompleted = urlParams.get('show_completed') || 'all';
    const filterBy = urlParams.get('filter_by') || '';

    // Apply filters immediately on page load
    applyClientSideFilters(showCompleted, filterBy);

    // Add event listeners to filter form elements
    const showCompletedSelect = document.getElementById('show_completed');
    const filterBySelect = document.getElementById('filter_by');

    if (showCompletedSelect) {
        showCompletedSelect.addEventListener('change', function() {
            const showCompleted = this.value;
            const filterBy = filterBySelect ? filterBySelect.value : '';
            applyClientSideFilters(showCompleted, filterBy);
        });
    }

    if (filterBySelect) {
        filterBySelect.addEventListener('change', function() {
            const filterBy = this.value;
            const showCompleted = showCompletedSelect ? showCompletedSelect.value : 'all';
            applyClientSideFilters(showCompleted, filterBy);
        });
    }
}

function initializeClientSideFiltering() {
    // Get current filter state from URL params on page load
    const urlParams = new URLSearchParams(window.location.search);
    const showCompleted = urlParams.get('show_completed') || 'all';
    const filterBy = urlParams.get('filter_by') || '';

    // Apply filters immediately on page load if URL params exist
    if (urlParams.has('show_completed') || urlParams.has('filter_by')) {
        applyClientSideFilters(showCompleted, filterBy);
    }

    // Add event listener to the filter form for the Apply button
    const filterForm = document.querySelector('form[action*="index"]');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            // Prevent default form submission
            e.preventDefault();

            // Get current filter values
            const showCompletedSelect = document.getElementById('show_completed');
            const filterBySelect = document.getElementById('filter_by');
            const sortBySelect = document.getElementById('sort_by');

            const showCompleted = showCompletedSelect ? showCompletedSelect.value : 'all';
            const filterBy = filterBySelect ? filterBySelect.value : '';
            const sortBy = sortBySelect ? sortBySelect.value : 'priority';

            // Apply client-side filtering
            applyClientSideFilters(showCompleted, filterBy);

            // Apply sorting if needed
            applySorting(sortBy);

            // Optional: Update URL without page reload
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('show_completed', showCompleted);
            newUrl.searchParams.set('filter_by', filterBy);
            newUrl.searchParams.set('sort_by', sortBy);

            // Remove empty parameters
            if (!filterBy) newUrl.searchParams.delete('filter_by');
            if (showCompleted === 'all') newUrl.searchParams.delete('show_completed');

            window.history.replaceState({}, '', newUrl);
        });
    }
}

// Add sorting functionality
function applySorting(sortBy) {
    const taskList = document.querySelector('.task-list');
    if (!taskList) return;

    const taskContainers = Array.from(taskList.children);

    taskContainers.sort((a, b) => {
        if (sortBy === 'priority') {
            // Get priority values
            const aPriority = getPriorityValue(a);
            const bPriority = getPriorityValue(b);
            return bPriority - aPriority; // High to low priority
        } else if (sortBy === 'title') {
            // Get task titles
            const aTitle = getTaskTitle(a);
            const bTitle = getTaskTitle(b);
            return aTitle.localeCompare(bTitle);
        }
        return 0;
    });

    // Reorder DOM elements
    taskContainers.forEach(container => {
        taskList.appendChild(container);
    });
}

function getPriorityValue(container) {
    const priorityBadge = container.querySelector('.priority-badge, .badge');
    if (priorityBadge) {
        if (priorityBadge.classList.contains('priority-3') || priorityBadge.textContent.toLowerCase().includes('high')) {
            return 3;
        } else if (priorityBadge.classList.contains('priority-2') || priorityBadge.textContent.toLowerCase().includes('medium')) {
            return 2;
        } else if (priorityBadge.classList.contains('priority-1') || priorityBadge.textContent.toLowerCase().includes('low')) {
            return 1;
        }
    }
    return 2; // Default to medium priority
}

function getTaskTitle(container) {
    const titleElement = container.querySelector('.task-title, .card-body h6, .d-flex span');
    return titleElement ? titleElement.textContent.trim() : '';
}

function initializeAutoSave() {
    const forms = document.querySelectorAll('form');

    forms.forEach(form => {
        const inputs = form.querySelectorAll('input[type="text"], textarea');

        inputs.forEach(input => {
            input.addEventListener('input', function() {
                const formData = new FormData(form);
                const formId = form.id || 'unnamed-form';

                // Save to sessionStorage with fallback for environments that don't support it
                try {
                    const savedData = {};
                    for (let [key, value] of formData.entries()) {
                        savedData[key] = value;
                    }
                    // Using memory storage instead of sessionStorage for Claude environment
                    window.autoSaveData = window.autoSaveData || {};
                    window.autoSaveData[`autosave-${formId}`] = savedData;
                } catch (e) {
                    // Auto-save not available in this environment
                }
            });
        });
    });
}

function initializeDarkMode() {
    const darkModeToggle = document.getElementById('darkModeToggle');
    const body = document.body;

    // Check for saved dark mode preference
    let isDarkMode = false;
    try {
        // Using memory storage instead of sessionStorage for Claude environment
        isDarkMode = window.darkModeState === 'true';
    } catch (e) {
        // Fallback for environments without storage
    }

    if (isDarkMode) {
        body.classList.add('dark-mode');
        if (darkModeToggle) darkModeToggle.checked = true;
    }

    if (darkModeToggle) {
        darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
                body.classList.add('dark-mode');
                try {
                    window.darkModeState = 'true';
                } catch (e) {
                    // Fallback
                }
            } else {
                body.classList.remove('dark-mode');
                try {
                    window.darkModeState = 'false';
                } catch (e) {
                    // Fallback
                }
            }
        });
    }
}

function initializeMarkdownUpload() {
    const form = document.getElementById('markdownUploadForm');
    const fileInput = document.getElementById('markdownFile');
    const previewMode = document.getElementById('previewMode');
    const previewArea = document.getElementById('previewArea');
    const previewContent = document.getElementById('previewContent');
    const confirmImport = document.getElementById('confirmImport');
    const cancelImport = document.getElementById('cancelImport');

    let parsedTasks = [];

    if (fileInput && previewMode && previewArea && previewContent) {
        // File input change handler
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0 && previewMode.checked) {
                const file = this.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const content = e.target.result;
                    parsedTasks = parseMarkdownTasks(content);
                    displayPreview(parsedTasks);
                    previewArea.style.display = 'block';
                };

                reader.readAsText(file);
            }
        });

        // Preview mode toggle
        previewMode.addEventListener('change', function() {
            if (!this.checked) {
                previewArea.style.display = 'none';
            } else if (fileInput.files.length > 0) {
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        // Form submission handler
        if (form) {
            form.addEventListener('submit', function(e) {
                if (previewMode.checked && previewArea.style.display === 'block') {
                    e.preventDefault();
                }
            });
        }

        // Confirm import button
        if (confirmImport) {
            confirmImport.addEventListener('click', function() {
                const hiddenForm = document.createElement('form');
                hiddenForm.method = 'POST';
                hiddenForm.action = form.action;
                hiddenForm.style.display = 'none';

                // Add CSRF token
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = document.querySelector('input[name="csrf_token"]').value;
                hiddenForm.appendChild(csrfInput);

                // Add parsed tasks
                const tasksInput = document.createElement('input');
                tasksInput.type = 'hidden';
                tasksInput.name = 'parsed_tasks';
                tasksInput.value = JSON.stringify(parsedTasks);
                hiddenForm.appendChild(tasksInput);

                // Add default priority
                const priorityInput = document.createElement('input');
                priorityInput.type = 'hidden';
                priorityInput.name = 'default_priority';
                priorityInput.value = document.getElementById('defaultPriority').value;
                hiddenForm.appendChild(priorityInput);

                document.body.appendChild(hiddenForm);
                hiddenForm.submit();
            });
        }

        // Cancel import button
        if (cancelImport) {
            cancelImport.addEventListener('click', function() {
                previewArea.style.display = 'none';
                fileInput.value = '';
                parsedTasks = [];
            });
        }
    }

    // Markdown collapse button functionality
    const markdownHeader = document.getElementById('markdownHeader');
    if (markdownHeader) {
        markdownHeader.addEventListener('click', function() {
            const collapseElement = document.getElementById('markdownUploadCollapse');
            if (collapseElement) {
                const isCollapsed = collapseElement.classList.contains('show');
                collapseElement.classList.toggle('show', !isCollapsed);
            }
        });
    }
}

// =============================================================================
// MAIN INITIALIZATION
// =============================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize all functionality
    initializeSubtaskFunctionality();
    initializeDarkMode();
    initializeMarkdownUpload();
    initializeSearchFunctionality();
    initializeClientSideFiltering();
    initializeNestedTaskFeatures();
    initializeAutoSave();
});
</script>
{% endblock %}